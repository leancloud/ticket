openapi: '3.0.0'
info:
  title: TapDesk REST API
  version: '1.0'
  description: |
    ## é‰´æƒ

    è¯·å°† LeanCloud ç”¨æˆ·çš„ sessionToken å¡«å……åˆ° `x-lc-session` header ä¸­ã€‚

    ## é™„ä»¶

    TapDesk ä¸æ”¯æŒä¸­è½¬é™„ä»¶ï¼Œè¯·å…ˆé€šè¿‡ SDK å°†æ–‡ä»¶ä¸Šä¼ è‡³ LeanCloud ï¼Œå†ä½¿ç”¨æ–‡ä»¶ id åˆ›å»ºå·¥å•æˆ–å›å¤ã€‚

    ## ç›´æ¥è°ƒç”¨åº•å±‚å­˜å‚¨ API

    [å‚è€ƒæ–‡æ¡£](https://leancloud.cn/docs/rest_api.html)

    æ‰€æœ‰çš„ REST è¯·æ±‚éœ€è¦å¸¦ä¸Š `x-lc-id` å’Œ `x-lc-key` header ã€‚

    å¦‚æœå¸Œæœ›ç»•è¿‡ï¼ˆACL ç­‰ï¼‰æƒé™æ ¡éªŒæœºåˆ¶ï¼Œå¯ä»¥å°† x-lc-key çš„å€¼æ›¿æ¢ä¸º masterKey: `x-lc-key: {masterkey},master` ã€‚
    è¯·æ³¨æ„ masterKey ä¸åº”è¯¥åœ¨å®¢æˆ·ç«¯ç­‰ä¸å—ä¿¡ä»»çš„ç¯å¢ƒä¸‹ä½¿ç”¨ã€‚è¦æŸ¥çœ‹ appIdã€appKey ä¸ masterKeyï¼Œ è¯·è®¿é—® LeanCloud æ§åˆ¶å°ã€‚
servers:
  - url: /
    description: å½“å‰ç¯å¢ƒ
  - url: http://127.0.0.1:3000
    description: æœ¬åœ°å¼€å‘ç¯å¢ƒ
components:
  securitySchemes:
    sessionToken:
      type: apiKey
      in: header
      name: x-lc-session
  schemas:
    User:
      type: object
      properties:
        id:
          type: string
        nid:
          type: integer
        username:
          type: string
        email:
          type: string
          format: email
        tags:
          type: array
          items:
            type: string
        created_at:
          type: string
          format: date-time
    Group:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        role_id:
          type: string
          description: å®¢æœå¯¹åº”çš„è§’è‰²çš„ id
    Status:
      type: integer
      enum: [50, 120, 160, 220, 250, 280]
    File:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        mime:
          type: string
        url:
          type: string
    LatestReply:
      title: Latest reply
      type: object
      properties:
        author:
          type: object
          properties:
            id:
              type: string
            username:
              type: string
            name:
              type: string
            email:
              type: string
        content:
          type: string
        is_customer_service:
          type: boolean
        created_at:
          type: string
          format: date-time
    TicketItem:
      title: Ticket item
      type: object
      properties:
        id:
          type: string
        nid:
          type: integer
        title:
          type: string
        author_id:
          type: string
        author:
          $ref: '#/components/schemas/User'
        organization_id:
          type: string
        assignee_id:
          type: string
        assignee:
          $ref: '#/components/schemas/User'
        category_id:
          type: string
        content:
          type: string
        status:
          $ref: '#/components/schemas/Status'
        evaluation:
          $ref: '#/components/schemas/Evaluation'
        unread_count:
          type: integer
        reply_count:
          type: integer
        latest_reply:
          $ref: '#/components/schemas/LatestReply'
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
    TicketDetail:
      title: Ticket detail
      type: object
      properties:
        id:
          type: string
        nid:
          type: integer
        title:
          type: string
        category_id:
          type: string
        author_id:
          type: string
        author:
          $ref: '#/components/schemas/User'
        organization_id:
          type: string
        assignee_id:
          type: string
        assignee:
          $ref: '#/components/schemas/User'
        group:
          oneOf:
            - $ref: '#/components/schemas/Group'
          nullable: true
        content:
          type: string
        content_HTML:
          type: string
        file_ids:
          type: array
          items:
            type: string
        files:
          type: array
          items:
            $ref: '#/components/schemas/File'
        evaluation:
          oneOf:
            - $ref: '#/components/schemas/Evaluation'
          nullable: true
        joined_customer_service_ids:
          type: array
          items:
            type: string
        status:
          $ref: '#/components/schemas/Status'
        tags:
          type: array
          items:
            $ref: '#/components/schemas/Tag'
          description: å…¬å¼€æ ‡ç­¾
        private_tags:
          type: array
          items:
            $ref: '#/components/schemas/Tag'
          description: ç§æœ‰æ ‡ç­¾ï¼ˆä»…å®¢æœå¯è§ï¼‰
        metadata:
          type: object
        reply_count:
          type: integer
        latest_reply:
          $ref: '#/components/schemas/LatestReply'
        subscribed:
          deprecated: true
          type: boolean
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
    OpsLog:
      type: object
      oneOf:
        - properties:
            id:
              type: string
            action:
              type: string
              enum: [selectAssignee]
            assignee_id:
              type: string
            created_at:
              type: string
              format: date-time
        - properties:
            id:
              type: string
            action:
              type: string
              enum: [changeCategory]
            category_id:
              type: string
            operator_id:
              type: string
            created_at:
              type: string
              format: date-time
        - properties:
            id:
              type: string
            action:
              type: string
              enum: [changeAssignee]
            assignee_id:
              type: string
            operator_id:
              type: string
            created_at:
              type: string
              format: date-time
        - properties:
            id:
              type: string
            action:
              type: string
              enum: [changeGroup]
            group_id:
              type: string
            operator_id:
              type: string
            created_at:
              type: string
              format: date-time
        - properties:
            id:
              type: string
            action:
              type: string
              enum: [changeFields]
            changes:
              type: array
              items:
                type: object
                # TODO: shit!
            operator_id:
              type: string
            created_at:
              type: string
              format: date-time
        - properties:
            id:
              type: string
            action:
              type: string
              enum: [resolve]
            operator_id:
              type: string
            created_at:
              type: string
              format: date-time
        - properties:
            id:
              type: string
            action:
              type: string
              enum: [close]
            operator_id:
              type: string
            created_at:
              type: string
              format: date-time
    Tag:
      type: object
      properties:
        key:
          type: string
        value:
          type: string
    Evaluation:
      type: object
      properties:
        star:
          type: integer
          enum: [0, 1]
        content:
          type: string
      required: [star]
    FieldValue:
      title: Custom field value
      type: object
      properties:
        field:
          type: string
        value:
          oneOf:
            - type: string
            - type: array
              items:
                type: string
    Category:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        description:
          type: string
        parent_id:
          type: string
        position:
          type: integer
          description: åˆ†ç±»çš„ç›¸å¯¹ä½ç½®ï¼ŒåŒä¸€çº§åˆ†ç±»æ’åºæ—¶ä½¿ç”¨
        template:
          type: string
          deprecated: true
          description: åˆ†ç±»é—®é¢˜æ¨¡æ¿
        faq_ids:
          type: array
          items:
            type: string
        active:
          type: boolean
        group:
          type: object
          properties:
            objectId:
              type: string
        form_id:
          type: string
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
security:
  - sessionToken: []
tags:
  - name: ticket
  - name: category
paths:
  /api/1/tickets:
    post:
      tags: [ticket]
      summary: åˆ›å»ºå·¥å•
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                title:
                  type: string
                category_id:
                  type: string
                content:
                  type: string
                organization_id:
                  type: string
                file_ids:
                  type: array
                  items:
                    type: string
                metadata:
                  type: object
                form_values:
                  type: array
                  items:
                    $ref: '#/components/schemas/FieldValue'
              required: [title, content, category_id]
            examples:
              åˆ›å»ºæ™®é€šå·¥å•:
                value:
                  title: 'ä½ ä»¬ç»™æˆ‘æçš„è¿™ä¸ªå®¢æœç³»ç»Ÿå•Š'
                  category_id: 'replace-with-an-exist-category-id'
                  content: 'Excited!'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
    get:
      tags: [ticket]
      summary: æŸ¥è¯¢å·¥å•
      parameters:
        - name: page
          in: query
          schema:
            type: integer
            default: 1
          description: 'é¡µæ•°, èŒƒå›´ [1, +Infinity]'
        - name: page_size
          in: query
          schema:
            type: integer
            default: 10
          description: 'æ¯é¡µæ•°é‡, èŒƒå›´ [0, 1000]'
        - name: count
          in: query
          schema:
            type: boolean
          description: æ˜¯å¦é€šè¿‡ `x-total-count` header è¿”å›æ€»æ•°
        - name: nid
          in: query
          schema:
            type: integer
        - name: author_id
          in: query
          schema:
            type: string
        - name: organization_id
          in: query
          schema:
            type: string
        - name: category_id
          in: query
          schema:
            type: string
        - name: created_at_gte
          in: query
          schema:
            type: string
            format: date-time
          description: æŸ¥è¯¢åˆ›å»ºæ—¶é—´æ™šäºæˆ–ç­‰äºè¯¥å€¼çš„å·¥å•
        - name: created_at_lte
          in: query
          schema:
            type: string
            format: date-time
          description: æŸ¥è¯¢åˆ›å»ºæ—¶é—´æ—©äºæˆ–ç­‰äºè¯¥å€¼çš„å·¥å•
        - name: reply_count_gt
          in: query
          schema:
            type: integer
          description: æŸ¥è¯¢å›å¤æ•°é‡å¤§äºè¯¥å€¼çš„å·¥å•
        - name: status
          in: query
          schema:
            $ref: '#/components/schemas/Status'
          description: æŸ¥è¯¢çŠ¶æ€ç­‰äºè¯¥å€¼çš„å·¥å•ï¼Œå¤šä¸ªå€¼å¯ç”± `,` åˆ†éš”
        - name: evaluation_ne
          in: query
          schema:
            type: string
            enum: ['null']
          description: æŸ¥è¯¢å·²è¯„ä»·çš„å·¥å•
        - name: sort
          in: query
          schema:
            type: string
            enum:
              - created_at
              - created_at-desc
              - updated_at
              - updated_at-desc
              - status
              - status-desc
          description: |
            æ’åºå­—æ®µ, å¤šä¸ªå­—æ®µå¯ç”¨ `,` åˆ†éš”

            é»˜è®¤æ­£åºï¼Œå€’åºå¯åœ¨å­—æ®µæœ«å°¾æ·»åŠ  `-desc`
        - name: where
          in: query
          schema:
            type: object
          description: åº•å±‚æŸ¥è¯¢æ¡ä»¶
      responses:
        '200':
          description: OK
          headers:
            x-total-count:
              schema:
                type: string
                format: integer
              description: æ€»æ•°
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/TicketItem'
  /api/1/tickets/{id}:
    parameters:
      - name: id
        in: path
        schema:
          type: string
        required: true
    get:
      tags: [ticket]
      summary: è·å–å·¥å•
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TicketDetail'
    patch:
      tags: [ticket]
      summary: æ›´æ–°å·¥å•
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                category_id:
                  type: string
                assignee_id:
                  type: string
                  description: è´Ÿè´£äºº id ï¼Œå¯é€šè¿‡ç©ºå­—ç¬¦ä¸²å–æ¶ˆå…³è”
                group_id:
                  type: string
                  description: å®¢æœç»„ id ï¼Œå¯é€šè¿‡ç©ºå­—ç¬¦ä¸²å–æ¶ˆå…³è”
                organization_id:
                  type: string
                  description: å®¢æˆ·ç»„ç»‡ id
                tags:
                  deprecated: true
                  type: array
                  items:
                    $ref: '#/components/schemas/Tag'
                  description: å…¬å¼€æ ‡ç­¾
                private_tags:
                  deprecated: true
                  type: array
                  items:
                    $ref: '#/components/schemas/Tag'
                  description: ç§æœ‰æ ‡ç­¾ï¼ˆä»…å®¢æœå¯è§ï¼‰
                evaluation:
                  $ref: '#/components/schemas/Evaluation'
                subscribed:
                  deprecated: true
                  type: boolean
                  description: å½“å‰å®¢æœæ˜¯å¦å…³æ³¨è¯¥å·¥å•
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
  /api/1/tickets/{id}/replies:
    parameters:
      - name: id
        in: path
        schema:
          type: string
        required: true
    post:
      tags: [ticket]
      summary: åˆ›å»ºå›å¤
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                content:
                  type: string
                file_ids:
                  type: array
                  items:
                    type: string
                internal:
                  type: boolean
                  description: åˆ›å»ºä¸ºå†…éƒ¨å›å¤ï¼ˆä»…å®¢æœå¯è§ï¼‰
              required: [content]
            examples:
              åˆ›å»ºæ™®é€šå›å¤:
                value:
                  content: 'ä½ ä»¬ç»™æˆ‘æçš„è¿™ä¸ªå®¢æœç³»ç»Ÿå•Šâ€”â€”Excited!'
              åˆ›å»ºå¸¦é™„ä»¶çš„å›å¤:
                value:
                  content: 'å¦‚å›¾æ‰€ç¤º'
                  file_ids: ['uploaded-file-id']
              åˆ›å»ºä»…å®¢æœå¯è§çš„å›å¤:
                value:
                  content: 'è¿™ä¸ªç”¨æˆ·è€æ˜¯æä¸€äº›è«åå…¶å¦™çš„é—®é¢˜ ğŸ˜‘'
                  internal: true
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
    get:
      tags: [ticket]
      summary: è·å–å›å¤
      parameters:
        - name: created_at_gt
          in: query
          schema:
            type: string
          description: è·å–åˆ›å»ºæ—¶é—´å¤§äºè¯¥å€¼çš„å›å¤
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  type: object
                  properties:
                    id:
                      type: string
                    nid:
                      type: number
                    author_id:
                      type: string
                    author:
                      $ref: '#/components/schemas/User'
                    content:
                      type: string
                    content_HTML:
                      type: string
                    file_ids:
                      type: array
                      items:
                        type: string
                    files:
                      type: array
                      items:
                        $ref: '#/components/schemas/File'
                    is_customer_service:
                      type: boolean
                    internal:
                      type: boolean
                    created_at:
                      type: string
                      format: date-time
  /api/1/tickets/{id}/ops-logs:
    parameters:
      - name: id
        in: path
        schema:
          type: string
        required: true
    get:
      tags: [ticket]
      summary: è·å–æ“ä½œæ—¥å¿—
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/OpsLog'
  /api/1/tickets/{id}/operate:
    post:
      tags: [ticket]
      summary: æ“ä½œå·¥å•
      parameters:
        - name: id
          in: path
          schema:
            type: string
          required: true
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                action:
                  type: string
                  enum:
                    - replyWithNoContent
                    - replySoon
                    - resolve
                    - close
                    - reopen
            examples:
              æ— éœ€å›å¤:
                value:
                  action: replyWithNoContent
              ç¨åå›å¤:
                value:
                  action: replySoon
              å·²è§£å†³:
                value:
                  action: resolve
              å…³é—­:
                value:
                  action: close
              é‡æ–°æ‰“å¼€:
                value:
                  action: reopen
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
  /api/1/tickets/{id}/form-values:
    parameters:
      - name: id
        in: path
        schema:
          type: string
        required: true
    patch:
      tags: [ticket]
      summary: ä¿®æ”¹è‡ªå®šä¹‰å­—æ®µçš„å€¼
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                form_values:
                  type: array
                  items:
                    $ref: '#/components/schemas/FieldValue'
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
    get:
      tags: [ticket]
      summary: è·å–è‡ªå®šä¹‰å­—æ®µçš„å€¼
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/FieldValue'
  /api/1/categories:
    get:
      tags: [category]
      summary: è·å–åˆ†ç±»åˆ—è¡¨
      parameters:
        - name: active
          in: query
          schema:
            type: boolean
        - name: id
          in: query
          schema:
            type: string
          description: é™å®šåˆ†ç±»çš„ id ï¼Œå¤šä¸ª id å¯ç”¨ `,` åˆ†éš”
        - name: parent_id
          in: query
          schema:
            type: string
          allowEmptyValue: true
          description: çˆ¶åˆ†ç±» id ï¼Œç©ºå­—ç¬¦ä¸²è¡¨ç¤ºä¸å­˜åœ¨çˆ¶åˆ†ç±» id
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Category'

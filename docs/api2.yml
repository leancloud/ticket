openapi: '3.0.0'
info:
  title: TapSupport REST API
  version: '2.0'
servers:
  - url: /
    description: 当前环境
  - url: http://127.0.0.1:4000
    description: 开发环境
components:
  securitySchemes:
    Session token:
      type: apiKey
      in: header
      name: x-lc-session
  schemas:
    User:
      type: object
      properties:
        id:
          type: string
        username:
          type: string
        nickname:
          type: string
        avatarUrl:
          type: string
    Group:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
    Category:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        description:
          type: string
        parentId:
          type: string
          description: 父分类 ID，可以通过该属性构建一颗树
        position:
          type: number
          description: 同一个父分类下的序号
        active:
          type: boolean
        template:
          type: string
          deprecated: true
          description: 问题模板（已被表单替代）
    TicketField:
      type: object
      properties:
        id:
          type: string
        type:
          type: string
          enum:
            - text
            - multi-line
            - dropdown
            - multi-select
            - radios
            - file
        title:
          type: string
          description: 字段名称
        description:
          type: string
          description: 字段补充解释
        required:
          type: boolean
          description: 是否必填
    File:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        mime:
          type: string
        url:
          type: string
    Evaluation:
      type: object
      properties:
        star:
          type: integer
        content:
          type: string
    Ticket:
      type: object
      properties:
        id:
          type: string
          example: 5ff4324896ba311a0a411392
        nid:
          type: integer
          description: 自增 ID
          example: 21430
        title:
          type: string
        categoryId:
          type: string
        categoryPath:
          type: array
          items:
            type: object
            properties:
              id:
                type: string
              name:
                type: string
        authorId:
          type: string
        author:
          $ref: '#/components/schemas/User'
        assigneeId:
          type: string
        assignee:
          $ref: '#/components/schemas/User'
        groupId:
          type: string
        group:
          $ref: '#/components/schemas/Group'
        files:
          type: array
          items:
            $ref: '#/components/schemas/File'
        status:
          $ref: '#/components/schemas/Status'
        evaluation:
          $ref: '#/components/schemas/Evaluation'
        replyCount:
          type: integer
        firstCustomerServiceReplyAt:
          type: string
          format: date-time
        latestCustomerServiceReplyAt:
          type: string
          format: date-time
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
          deprecated: true
        contentSafeHTML:
          type: string
          description: 详细描述（安全的 HTML，已 XSS 过滤）（仅在非列表中出现)
        unreadCount:
          type: integer
          description: 当前用户未读数（仅在列表中出现）
    Status:
      type: integer
      enum: [50, 120, 160, 220, 250, 280]
    Notification:
      type: object
      properties:
        id:
          type: string
        ticket:
          $ref: '#/components/schemas/Ticket'
        unreadCount:
          type: number
        latestAction:
          type: string
          enum: ['newTicket', 'reply', 'changeAssignee', 'ticketEvaluation', 'changeStatus']
        latestActionAt:
          type: string
          format: date-time
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
    Article:
      type: object
      properties:
        id:
          type: string
        title:
          type: string
        content:
          type: string
        contentSafeHTML:
          type: string
        private:
          type: boolean
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
    Topic:
      type: object
      properties:
        id:
          type: string
        name:
          type: string
        meta:
          type: object
        articleIds:
          type: array
          items:
            type: string
        articles:
          type: array
          items:
            $ref: '#/components/schemas/Article'
          description: 仅在部分参数下返回值包含该字段
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
    Revision:
      type: object
      properties:
        id:
          type: string
        title:
          type: string
        comment:
          type: string
        meta:
          type: boolean
        private:
          type: boolean
        author:
          $ref: '#/components/schemas/User'
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
security:
  - Session token: []
paths:
  /api/2/users:
    post:
      tags: [User]
      summary: 登录
      description: request body 中提供的不同字段对应不同的登录方式，详细用法参见使用文档。
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                jwt:
                  type: string
                anonymousId:
                  type: string
                name:
                  type: string
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  sessionToken:
                    type: string

  /api/2/products/{pid}/categories:
    parameters:
      - name: pid
        in: path
        schema:
          type: string
        required: true
    get:
      tags: ['Category']
      summary: 获取分类列表
      parameters:
        - name: active
          in: query
          schema:
            type: boolean
          description: 是否只返回已启用的分类
          example: true
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Category'

  /api/2/categories/{cid}/fields:
    parameters:
      - name: cid
        in: path
        schema:
          type: string
        required: true
    get:
      tags: ['Category']
      summary: 获取某个分类关联的表单描述
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/TicketField'
  /api/2/categories/{cid}/faqs:
    parameters:
      - name: cid
        in: path
        schema:
          type: string
        required: true
    get:
      tags: ['Category', 'Knowladge base']
      summary: 获取与某个分类关联的常见问题
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Article'
  /api/2/products/{cid}/topics:
    parameters:
      - name: cid
        in: path
        schema:
          type: string
        required: true
    get:
      tags: ['Category', 'Knowladge base']
      summary: 获取与某个分类关联的 Topics
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Topic'

  /api/2/tickets:
    get:
      tags: [Ticket]
      summary: 查询工单
      parameters:
        - name: page
          in: query
          schema:
            type: integer
          description: 页数，范围：[1, Infinity)
        - name: pageSize
          in: query
          schema:
            type: integer
          description: 每页数量，范围：[0, 100]，默认为 10
        - name: count
          in: query
          schema:
            type: boolean
          description: 为 `true` 时通过 x-total-count 返回符合条件的工单数量
        - name: authorId
          in: query
          schema:
            type: string
          description: 工单创建者 ID
        - name: assigneeId
          in: query
          schema:
            type: string
          description: 工单负责人 ID，多个值可用 `,` 分隔。`null` 表示未分配负责人
        - name: groupId
          in: query
          schema:
            type: string
          description: 客服组 ID，多个值可用 `,` 分隔。`null` 表示未分配客服组
        - name: categoryId
          in: query
          schema:
            type: string
          description: 分类 ID，多个值可用 `,` 分隔
        - name: product
          in: query
          schema:
            type: string
          description: 根分类 ID，等同于将 categoryId 设置为 product + 其下所有子分类的 ID
        - name: status
          in: query
          schema:
            $ref: '#/components/schemas/Status'
        - name: evaluation.star
          in: query
          schema:
            type: integer
            enum: [0, 1]
          description: 评价星级
        - name: createdAt
          in: query
          schema:
            type: string
          description: |
            创建时间的范围，格式为：`{starts}..{ends}`，缺省值用 `*` 表示：

            `2021-09-01T00:00:00.000..*`

            `*..2021-09-30T23:59:59.999`

            `2021-09-01T00:00:00.000..2021-09-30T23:59:59.999`
        - name: orderBy
          in: query
          schema:
            type: string
            enum:
              - createdAt
              - createdAt-desc
              - updatedAt
              - updatedAt-desc
              - latestCustomerServiceReplyAt
              - latestCustomerServiceReplyAt-desc
              - status
              - status-desc
          description: 排序字段，默认为升序，`-desc` 后缀表示降序
        - name: include
          in: query
          schema:
            type: string
          description: |
            将指定字段包含进查询结果中。可选值：
            - author
            - assignee
            - category
            - categoryPath
            - group（仅客服可用）
            - files
            - unreadCount

            多个值可用 `,` 分隔
        - name: includeMetaKeys
          in: query
          schema:
            type: string
          description: 将指定 metaData 字段包含进查询结果中，多个值可用 `,` 分隔。
        - name: where
          in: query
          schema:
            type: string
          description: （谨慎使用）底层查询条件，格式为 JSON 字符串。详见 [LeanCloud REST API 文档](https://leancloud.cn/docs/rest_api.html)
      responses:
        '200':
          description: OK
          headers:
            x-total-count:
              schema:
                type: string
                format: integer
              description: 符合条件的工单数量
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Ticket'
    post:
      tags: [Ticket]
      summary: 创建工单
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                categoryId:
                  type: string
                title:
                  type: string
                  description: 标题，最大长度 100 字符（已被表单系统字段代替）
                  deprecated: true
                content:
                  type: string
                  description: 内容，支持 Markdown（已被表单系统字段代替）
                  deprecated: true
                fileIds:
                  type: array
                  items:
                    type: string
                  description: 附件文件 ID 列表（已被表单系统字段代替）
                  deprecated: true
                customFields:
                  type: array
                  description: 工单字段
                  items:
                    type: object
                    properties:
                      field:
                        type: string
                        description: 工单字段 ID
                      value:
                        type: mixed
                        description: 工单字段值
              required: [title, categoryId]
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string

  /api/2/tickets/{id}/replies:
    parameters:
      - name: id
        in: path
        schema:
          type: string
        required: true
    post:
      tags: [Ticket]
      summary: 创建回复
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                content:
                  type: string
                fileIds:
                  type: array
                  items:
                    type: string
                internal:
                  type: boolean
                  description: 创建为内部回复（仅客服可见，该参数仅客服有效）
              required: [content]
            examples:
              创建普通回复:
                value:
                  content: '你们给我搞的这个客服系统啊——Excited!'
              创建带附件的回复:
                value:
                  content: '如图所示'
                  fileIds: ['uploaded-file-id']
              创建仅客服可见的回复:
                value:
                  content: '这个用户老是提一些莫名其妙的问题 😑'
                  internal: true
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
                properties:
                  id:
                    type: string
                  content:
                    type: string
                  contentSafeHTML:
                    type: string
                  author:
                    $ref: '#/components/schemas/User'
                  isCustomerService:
                    type: boolean
                  files:
                    type: array
                    items:
                      $ref: '#/components/schemas/File'
                  createdAt:
                    type: string
                    format: date-time
                  updatedAt:
                    type: string
                    format: date-time
  /api/2/unread:
    get:
      tags: ['Notification']
      summary: 获取当前用户是否有未读的通知
      description: 通常用于判断是否要显示小红点
      responses:
        '200':
          description: 返回 true / false
          content:
            application/json:
              schema:
                type: boolean
      parameters:
        - name: product
          in: query
          schema:
            type: string
          description: 只返回属于指定 product 下的分类的工单的未读情况
  /api/2/notifications:
    get:
      tags: ['Notification']
      summary: 获取当前用户工单更新通知
      parameters:
        - name: product
          in: query
          schema:
            type: string
          description: 只返回属于指定 product 下的分类的工单更新通知
        - name: unread
          in: query
          schema:
            type: string
          description: 如该参数出现（值可以任意指定），则仅返回未读的通知
        - name: before
          in: query
          schema:
            type: string
            description: ISO 时间戳，配合返回值中的 latestActionAt 翻页
        - name: limit
          in: query
          schema:
            type: number
            description: 每页条数，默认 25，最大 999
        - name: includeTicketMetaKeys
          in: query
          schema:
            type: string
            description: 在返回结果的 ticket 包含的 metaData 字段列表，多个值用 `,` 分隔
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Notification'
  /api/2/notifications/read-all:
    post:
      tags: ['Notification']
      summary: 批量将所有未读通知标为已读
      parameters:
        - name: product
          in: query
          schema:
            type: string
          description: 只标记指定 product 下的分类的工单已读
      responses:
        '200':
          description: Done

  /api/2/articles:
    get:
      tags: ['Knowladge base']
      summary: 查询文章
      parameters:
        - name: page
          in: query
          schema:
            type: integer
          description: 页数，范围：[1, Infinity)
        - name: pageSize
          in: query
          schema:
            type: integer
          description: 每页数量，范围：[0, 100]，默认为 20
        - name: private
          in: query
          schema:
            type: boolean
          description: 指定仅返回 private / public 的文章，仅对客服账号生效（用户仅能看到 public 的文章）
        - name: count
          in: query
          schema:
            type: boolean
          description: 为 `true` 时通过 x-total-count 返回符合条件的文章数量
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Article'
    post:
      tags: ['Knowladge base']
      summary: 创建文章
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                title:
                  type: string
                content:
                  type: string
                private:
                  type: boolean
              required: [title, content]
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Article'

  /api/2/articles/{id}:
    parameters:
      - name: id
        in: path
        schema:
          type: string
        required: true
    get:
      tags: ['Knowladge base']
      summary: 获取文章
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Article'
    patch:
      tags: ['Knowladge base']
      summary: 更新文章
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                title:
                  type: string
                content:
                  type: string
                private:
                  type: boolean
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
    delete:
      tags: ['Knowladge base']
      summary: 删除文章
      description: 已上线（public）的文章不可删除，使用中（有关联的分类）的文章不可删除。
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
  /api/2/articles/{id}/categories:
    parameters:
      - name: id
        in: path
        schema:
          type: string
        required: true
    get:
      tags: ['Knowladge base']
      summary: 获取关联了该文章为常见问题或公告的分类
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Category'

  /api/2/articles/{id}/feedback:
    parameters:
      - name: id
        in: path
        schema:
          type: string
        required: true
    post:
      tags: ['Knowladge base']
      summary: 提交文章反馈
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                type:
                  type: integer
                  enum: [-1, 1]
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object

  /api/2/articles/{id}/revisions:
    parameters:
      - name: id
        in: path
        schema:
          type: string
        required: true
      - name: page
        in: query
        schema:
          type: integer
        description: 页数，范围：[1, Infinity)
      - name: pageSize
        in: query
        schema:
          type: integer
        description: 每页数量，范围：[0, 100]，默认为 20
      - name: meta
        in: query
        schema:
          type: boolean
        description: 为真时仅返回发布、撤销发布记录，为假时仅返回内容修改记录
      - name: count
        in: query
        schema:
          type: boolean
        description: 为 `true` 时通过 x-total-count 返回符合条件的记录数量
    get:
      tags: ['Knowladge base']
      summary: 获取文章修改记录
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Revision'

  /api/2/products/{pid}/notices:
    parameters:
      - name: pid
        in: path
        schema:
          type: string
        required: true
    get:
      tags: ['Knowladge base']
      summary: 获取公告
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Category'

  /api/2/topics:
    get:
      tags: ['Knowladge base']
      summary: 查询 Topic
      parameters:
        - name: page
          in: query
          schema:
            type: integer
          description: 页数，范围：[1, Infinity)
        - name: pageSize
          in: query
          schema:
            type: integer
          description: 每页数量，范围：[0, 100]，默认为 10
        - name: count
          in: query
          schema:
            type: boolean
          description: 为 `true` 时通过 x-total-count 返回符合条件的 topic 数量
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/Topic'
    post:
      tags: ['Knowladge base']
      summary: 创建 Topic
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                articleIds:
                  type: array
                  items:
                    type: string
                meta:
                  type: object
              required: [name, articleIds]
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Topic'

  /api/2/topics/{id}:
    parameters:
      - name: id
        in: path
        schema:
          type: string
        required: true
    get:
      tags: ['Knowladge base']
      summary: 获取 Topic
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Topic'
    patch:
      tags: ['Knowladge base']
      summary: 更新 Topic
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                articleIds:
                  type: array
                  items:
                    type: string
                meta:
                  type: object
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object
    delete:
      tags: ['Knowladge base']
      summary: 删除 Topic
      description: 使用中（有关联的分类）的文章不可删除。
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: object

  /api/2/external-files:
    post:
      tags: [File]
      summary: 注册外部文件
      description: 支持提交文件的接口使用文件 ID 作为参数，外部文件需要先通过此接口注册以获取文件 ID。
      requestBody:
        content:
          application/json:
            schema:
              type: array
              items:
                type: object
                properties:
                  url:
                    type: string
                    required: true
                  name:
                    type: string
                    description: 用户文件展示时的名字。如不指定则使用 URL 中的最后一级路径。
                  metaData:
                    type: object
                    description: KV 接口的的元数据，可用于筛选。
      responses:
        '200':
          description: OK
          content:
            application/json:
              schema:
                type: array
                items:
                  type: string
                  description: 文件 ID
